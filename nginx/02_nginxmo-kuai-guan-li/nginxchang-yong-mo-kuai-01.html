<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx常用模块一 | ONEMUE Docs</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="This is a Docs.">
    
    <link rel="preload" href="/docs/assets/css/0.styles.90a57e95.css" as="style"><link rel="preload" href="/docs/assets/js/app.27b283a1.js" as="script"><link rel="preload" href="/docs/assets/js/2.2e8f894a.js" as="script"><link rel="preload" href="/docs/assets/js/11.84b24849.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.f6f629b0.js"><link rel="prefetch" href="/docs/assets/js/12.76af45bb.js"><link rel="prefetch" href="/docs/assets/js/13.c0ae4be6.js"><link rel="prefetch" href="/docs/assets/js/14.4f6283b3.js"><link rel="prefetch" href="/docs/assets/js/15.002291f6.js"><link rel="prefetch" href="/docs/assets/js/16.5dfc5cc5.js"><link rel="prefetch" href="/docs/assets/js/17.14f17db6.js"><link rel="prefetch" href="/docs/assets/js/18.971e9caa.js"><link rel="prefetch" href="/docs/assets/js/19.889fb802.js"><link rel="prefetch" href="/docs/assets/js/20.d1be27fd.js"><link rel="prefetch" href="/docs/assets/js/21.83fd3971.js"><link rel="prefetch" href="/docs/assets/js/22.6bc785a8.js"><link rel="prefetch" href="/docs/assets/js/23.c9474e02.js"><link rel="prefetch" href="/docs/assets/js/24.054109cd.js"><link rel="prefetch" href="/docs/assets/js/25.c7f91c21.js"><link rel="prefetch" href="/docs/assets/js/3.ea118fbe.js"><link rel="prefetch" href="/docs/assets/js/4.6fbf7596.js"><link rel="prefetch" href="/docs/assets/js/5.f7d53cbe.js"><link rel="prefetch" href="/docs/assets/js/6.db4bfcd5.js"><link rel="prefetch" href="/docs/assets/js/7.2123913f.js"><link rel="prefetch" href="/docs/assets/js/8.c52818c0.js"><link rel="prefetch" href="/docs/assets/js/9.20e728b8.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.90a57e95.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">ONEMUE Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/docs/" aria-current="page" class="sidebar-link">内容构建中</a></li><li><a href="/docs/unicloud.html" class="sidebar-link">出现两年的 uniCloud</a></li><li><a href="/docs/han-shu-de-yi-xie-yan-jiu.html" class="sidebar-link">/han-shu-de-yi-xie-yan-jiu.html</a></li><li><a href="/docs/mian-shi.html" class="sidebar-link">面试汇总</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java Script</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Nginx</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Nginx安装及配置</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Nginx模块管理</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/nginx/02_nginxmo-kuai-guan-li/nginxchang-yong-mo-kuai-01.html" aria-current="page" class="active sidebar-link">Nginx常用模块一</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/nginx/02_nginxmo-kuai-guan-li/nginxchang-yong-mo-kuai-01.html#_1、核心功能-core-functionality" class="sidebar-link">1、核心功能(Core functionality)</a></li><li class="sidebar-sub-header"><a href="/docs/nginx/02_nginxmo-kuai-guan-li/nginxchang-yong-mo-kuai-01.html#_2、http核心模块-ngx-http-core-module" class="sidebar-link">2、http核心模块 （ngx httpcore_module）</a></li><li class="sidebar-sub-header"><a href="/docs/nginx/02_nginxmo-kuai-guan-li/nginxchang-yong-mo-kuai-01.html#_3-访问控制模块" class="sidebar-link">3，访问控制模块</a></li><li class="sidebar-sub-header"><a href="/docs/nginx/02_nginxmo-kuai-guan-li/nginxchang-yong-mo-kuai-01.html#_4、用户认证模块-ngx-http-auth-basic-module" class="sidebar-link">4、用户认证模块(ngx http auth basic_ module)</a></li><li class="sidebar-sub-header"><a href="/docs/nginx/02_nginxmo-kuai-guan-li/nginxchang-yong-mo-kuai-01.html#_5、基本状态查看模块-ngx-http-stub-status-module" class="sidebar-link">5、基本状态查看模块(ngxhttpstubstatusmodule)</a></li></ul></li><li><a href="/docs/nginx/02_nginxmo-kuai-guan-li/nginxchang-yong-mo-kuai-02.html" class="sidebar-link">Nginx常用模块二</a></li><li><a href="/docs/nginx/02_nginxmo-kuai-guan-li/nginxchang-yong-mo-kuai-03.html" class="sidebar-link">Nginx常用模块三</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>LNMP环境部署</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Nginx优化管理</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>代码</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>收藏文章</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx常用模块一"><a href="#nginx常用模块一" class="header-anchor">#</a> Nginx常用模块一</h1> <p>​	Nginx由内核和模块组成。Nginx本身做的工作实际很少，当它接到一个HTTP请求时，它仅仅是通过查找配置文件将此次请求映射到一个location block,而此location中所配置的各个指令则会启动不同的模块去完成工作，因此模块可以看做Nginx真正的劳动工作者. 通常一个location中的指令会涉及一个handler模块和多个filter模块(当然，多个location可以复用同一个模块) 。 handler模块负责处理请求,完成响应内容的生成，而filter模块对响应内容进行处理。用户根据自己的需要所开发的模块都属于第三方模块。正是有了这么多模块的支撑，Nginx的功能才会如此强大。</p> <p>Nginx的模块从结构上分为核心模块、基础模块和第三方模块:</p> <ul><li>核心模块: HTTP模块、EVENT模块和MAIL模块;</li> <li>基础模块: HTTP Access模块、HTTP FastCGI模块、HTTP Proxy模块和HTTP Rewrite模块;</li> <li>第三方模块: HTTP Upstream Request Hash模块、 Notice模块和HTTP Access Key模块。</li></ul> <p>Nginx的模块从功能上分为如下三类:</p> <ul><li>Handlers (处理器模块)：此类模块直接处理请求,并进行输出内容和修改headers信息等操作。Handlers处理器模块般只能有一个;</li> <li>Filters (过滤器模块)：此类模块主要对其他处理器模块输出的内容进行修改操作,最后Nginx输出;</li> <li>Proxies (代理类模块)：此类模块是Nginx的HTTP Upstream之类的模块，这些模块主要与后端一些服务比如FastCG|等进行交互，实现服务代理和负载均衡等功能。</li></ul> <h2 id="_1、核心功能-core-functionality"><a href="#_1、核心功能-core-functionality" class="header-anchor">#</a> 1、核心功能(Core functionality)</h2> <p>functionality [ˌfʌŋkʃəˈnæləti] 功能</p> <ul><li>worker_processes</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> worker_processes number | auto</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> worker_processes <span class="token number">1</span></span><span class="token punctuation">;</span>
Context: main
</code></pre></div><p>最佳值取决于许多因素，包括(但不限于) CPU核心的数量、存储数据的硬盘驱动器的数量和负载模式。一般将其设置为可用CPU核心的数量。</p> <ul><li>worker_cpu_affinity ( [əˈfɪnəti] )</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> worker_cpu_affinity cpumask ...</span><span class="token punctuation">;</span>
	    <span class="token directive"><span class="token keyword">worker_cpu_affinity</span> auto [cpumask]</span><span class="token punctuation">;</span>
Default: -
Context: main
</code></pre></div><p>将工作进程绑定到CPU集。每个CPU集由允许的CPU的位掩码表示。应该为每个工作进程定义一个单独的集合。默认情况下,工作进程不绑定到任何特定的CPU。该指令仅在FreeBSD和Linux上可用。</p> <p>例如:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">worker_processes</span> <span class="token number">4</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_cpu_affinity</span> <span class="token number">0001</span> <span class="token number">0010</span> <span class="token number">0100</span> <span class="token number">1000</span></span><span class="token punctuation">;</span>
<span class="token comment">#将每个工作进程绑定到单独的CPU</span>

<span class="token directive"><span class="token keyword">worker_processes</span> <span class="token number">2</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_cpu_affinity</span> <span class="token number">0101</span> <span class="token number">1010</span></span><span class="token punctuation">;</span>
<span class="token comment">#将第一个工作进程绑定到CPU0/CPU2,将第二个工作进程绑定到CPU1/CPU3，这个例子适用于超线程情况</span>

<span class="token directive"><span class="token keyword">worker_processes</span> auto</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_cpu_affinity</span> auto</span><span class="token punctuation">;</span>
<span class="token comment">#1.9.10版本后允许将工作进程自动绑定到可用的CPU</span>
</code></pre></div><ul><li>worker_priority ( [praɪˈɔːrəti])</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> worker_priority number</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> worker_priority <span class="token number">0</span></span><span class="token punctuation">;</span>
Context: main
</code></pre></div><p>为工作进程定义调度优先级，就像由nice命令执行一样: 负数表示优先级更高。允许范围通常在20到20之间</p> <ul><li>worker_rlimit_nofile</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> worker_rlimit_nofile number</span><span class="token punctuation">;</span>
Default: -
Context: main
</code></pre></div><p>更改工作进程的最大打开文件数(rlimit_nofile)限制，默认较小，生产环境一般需要调高，如: 65535.（需要同时修改linux同一时间开启的文件数）</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 修改linux的同一时间最多可开启的文件数</span>
$ <span class="token builtin class-name">ulimit</span> -n <span class="token number">65535</span>
<span class="token comment"># 如果需要永久修改 则需要修改配置文件/etc/security/limits.conf</span>
* soft nofile <span class="token number">65536</span>      <span class="token comment"># open files  (-n)</span>
* hard nofile <span class="token number">65536</span>
 
* soft nproc <span class="token number">65565</span>
* hard nproc <span class="token number">65565</span>       <span class="token comment"># max user processes   (-u)</span>
</code></pre></div><ul><li>worker_connection</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> worker_connections number</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> worker_connections <span class="token number">1024</span></span><span class="token punctuation">;</span>
Context: events
</code></pre></div><p>设置能够被一个工作进程打开的最大并发连接数。应该记住，这个数字包括所有连接(例如，与代理服务器的连接等)，而不仅仅是与客户机的连接。另一个需要考虑的问题是，实际同时连接的数量不能超过打开文件的最大数量的当前限制( worker_rlimit_nofile.) 。</p> <ul><li>use</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> use method</span><span class="token punctuation">;</span>
Default: -
Context: events
</code></pre></div><p>指定要使用的连接处理方法。通常不需要显式地指定它，因为nginx默认使用最有效的方法。如: useepoll;</p> <ul><li>accept_mutex （ [əkˈsept]  //,mjuː ˈtɛks// 接受互斥）</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> accept_mutex on|off</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> accept_mutex <span class="token boolean">off</span></span><span class="token punctuation">;</span>
Context: events
</code></pre></div><p>如果启用:on，工作进程将轮流接受新的连接。否则将通知所有工作进程有关新连接的信息，但只有一个进程可以获得连接。如果新连接的数量较低，则某些工作进程可能会浪费系统资源。在版本1.11.3之前，默认值为on。并发多的时候建议开启。</p> <h2 id="_2、http核心模块-ngx-http-core-module"><a href="#_2、http核心模块-ngx-http-core-module" class="header-anchor">#</a> 2、http核心模块 （ngx _http_core_module）</h2> <ul><li>http</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> http</span> <span class="token punctuation">{</span> ... <span class="token punctuation">}</span>
Default: -
Context: main
</code></pre></div><p>提供配置文件上下文，其里面指定HTTP服务器指令</p> <ul><li>server</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> server</span> <span class="token punctuation">{</span> ... <span class="token punctuation">}</span>
Default: -
Context: http
</code></pre></div><p>配置虚拟主机。基于IP的和基于域名的虚拟主机。listen指令描述了接收连接的所有地址和端口 , server_name指令列出了所有的域名。</p> <ul><li>listen</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> listen address [:port] [defau1t_server] [ss1] [http2 | spdy]
[proxy_protoco1] [setfib=number] [fastopen=number] [backlog=number]
[rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred] [bind]
[ipv6only=on|off] [reuseport] [so_keepalive=on|off| [keepid1e] : [keepintv1]:[keepcnt]]</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">listen</span> port [default_server] [ss1] [http2|spdy] [proxy_protoco1]
[setfib=number] [fastopen=number] [backlog=number] [rcvbuf=size] [sndbuf=size]
[accept_filter=filter] [deferred] [bind] [ipv6only=on|off] [reuseport]
[so_keepalive=on|off|[keepid1e] : [keepintv1] : [keepcnt]]</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">listen</span> unix:path [default_server] [ssl] [http2|spdy] [proxy_protoco1]
[backlog=number] [rcvbuf=size] [sndbuf=size] [accept_filter=filter] [deferred]
[bind] [so_keepalive=on|off|[keepidle]:[keepintv1]:[keepcnt]]</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> listen *:80 | *:8000</span><span class="token punctuation">;</span> <span class="token comment">#默认值</span>
Context: server <span class="token comment">#使用字段：server</span>
</code></pre></div><p>设置IP的地址和端口，或服务器将接受请求的Unix域套接字的路径,例如:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">listen</span> 127.0.0.1:8000</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">listen</span> 127.0.0.1</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">listen</span> <span class="token number">8000</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">listen</span> *:8000</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">listen</span> localhost:8000</span><span class="token punctuation">;</span>
<span class="token comment"># ipv6地址格式（0.7.36）在一个方括号中指定：</span>
<span class="token directive"><span class="token keyword">listen</span> [::]:8000</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">listen</span> [fe80::1]</span><span class="token punctuation">;</span>
<span class="token comment"># 0.8.21版本以后nginx可以监听unix套接口：</span>
<span class="token directive"><span class="token keyword">listen</span> unix:/tmp/nginx1.sock</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>server_name</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> server_name name ...</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> server_name <span class="token string">&quot;&quot;</span></span><span class="token punctuation">;</span>
Context: server
</code></pre></div><p>设置虚拟服务器的名字。例如:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
<span class="token directive"><span class="token keyword">server_name</span> example.com www.example.com</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">#服务器名称可以包括星号(&quot;*&quot;) 来替换名称的第一部分或最后一部分:</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
<span class="token directive"><span class="token keyword">server_name</span> example.com * .example.com www.example.*</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">#支持~起始的字符做正则表达式模式匹配，性能原因慎用</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
<span class="token directive"><span class="token keyword">server_name</span> www.example.com~^www\d+\.example\.com$</span><span class="token punctuation">;</span> <span class="token comment"># \d表示[0-9]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>匹配优先级机制从高到低:</p> <ol><li>首先是字符串精确匹配如:https://www.cnblogs.com/ykzou/p/5840729.html</li> <li>左侧通配符如：*.demo</li> <li>右侧通配符如：demo.*</li> <li>正则表达式如：-^.*.demo</li> <li>default_server</li></ol> <ul><li>root</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> root path</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> root html</span><span class="token punctuation">;</span>
Context: http, server, location, if in location
</code></pre></div><p>设置请求的根目录，例如：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /i/</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">root</span> /data/w3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment"># /data/w3/i/top.gif文件将响应&quot;/i/top.gif&quot;请求而发送</span>
<span class="token comment"># 路径值可以包含变量，除了$document_root和$realpath_root。</span>
</code></pre></div><ul><li>alias [ˈeɪliəs]</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> alias path</span><span class="token punctuation">;</span>
Default: -
Context：1ocation
</code></pre></div><p>定义指定的location的一个替换</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /i/</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">alias</span> /data/w3/images/</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">#对于&quot;/i/top.gif&quot;的请求,将发送文件/data/w3/images/top.gif。</span>
<span class="token comment">#路径值可以包含变量，除了$document_root和$realpath_root</span>
<span class="token comment">#alias后面必须要用 &quot;/&quot; 结束，否则会找不到文件</span>
<span class="token comment">#如果alias配置在正则匹配的location内，则正则表达式中必须包含捕获语句(也就是括号())，</span>
<span class="token comment">#而且alias配置中也要引用这些捕获值。如:</span>
<span class="token directive"><span class="token keyword">location</span> ~ ^/users/(.+\.(?:gif|jpe?g|png))$</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">alias</span> /data/w3/images/<span class="token variable">$1</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 关于alias和root的区别： </span>
<span class="token comment"># root和alias是系统文件路径的设置。 </span>
<span class="token comment"># root用来设置根目录，而alias用来重置当前文件的目录。</span>

<span class="token directive"><span class="token keyword">location</span> /img/</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">alias</span> /var/www/image/</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">#若按照上述配置的话，则访问/img/目录里面的文件时，ningx会自动去/var/www/image/目录找文件</span>
<span class="token directive"><span class="token keyword">location</span> /img/</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">root</span> /var/www/image</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">#若按照这种配置的话，则访问/img/目录下的文件时，nginx会去/var/www/image/img/目录下找文件。</span>
</code></pre></div><ul><li>location</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> location [ = | ~ | ~* | ^~ ] uri</span> <span class="token punctuation">{</span> ... <span class="token punctuation">}</span>
	<span class="token directive"><span class="token keyword">location</span> @name</span> <span class="token punctuation">{</span> ... <span class="token punctuation">}</span>
Default: -
Context: server, location
</code></pre></div><p>根据请求的URI设置配置。
在一个server中location配置段可存在多个，用于实现URI到文件系统的路径映射；</p> <p>匹配字符串分为两种：普通字符串 (literal string) 和正则表达式 (regular expression) ，其中 ~ 和 ~* 用于正则表达式，其他前缀和无任何前缀都用于普通字符串。</p> <p><strong>匹配顺序是</strong></p> <ol><li>先匹配普通字符串，将相对最精确的匹配暂时存储；</li> <li>然后按照配置文件中的声明顺序进行正则表达式匹配，只要匹配到一条正则表达式，则停止匹配，取正则表达式为匹配结果;</li> <li>如果所有正则表达式都匹配不上,则取1中存储的结果；</li> <li>如果普通字符串和正则表达式都匹配不上，则报404 NOT FOUND</li> <li>&quot;^~ &quot;和&quot;=&quot;都能阻止继续搜索正则location。不同点是&quot;^~“依然遵守&quot;最大前缀&quot;匹配规则，然而&quot;=&quot;不是&quot;最大前缀”，而是必须是严格匹配</li> <li>只要遇到&quot;完全匹配（exact match[ɪɡˈzækt mætʃ]）&quot;，即使普通location 没有带&quot;=&quot;或&quot;^~&quot;前缀，也一样会终止后面的匹配。</li></ol> <p>例如:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>location = /uri		=开头表示精确前缀匹配，只有完全匹配才能生效。
location ^~ /uri	^~开头表示普通字符串匹配上以后不再进行正则匹配。
location ~ pattern	~开头表示区分大小写的正则匹配。
location ~* pattern	~*开头表示不区分大小写的正则匹配。
location /uri	不带任何修饰符，表示前缀匹配。
location /	通用匹配，任何未匹配到其他location的请求都会匹配到。
</code></pre></div><p>配置举例：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> = /</span> <span class="token punctuation">{</span>
	[ configuration A ]
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
	[ configuration B ]
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> /documents/</span> <span class="token punctuation">{</span>
	[ configuration C ]
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> ^~ /images/</span> <span class="token punctuation">{</span>
	[ configuration D ]
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> ~* \. (gif | jpg | jpeg)$</span> <span class="token punctuation">{</span>
	[ configuration E ]
<span class="token punctuation">}</span>
    
<span class="token comment"># &quot;/&quot;请求匹配configuration A:</span>
<span class="token comment"># &quot;/index.html&quot;请求匹配configuration B:</span>
<span class="token comment"># &quot;/documents/document. . html&quot;请求匹配configuration C:</span>
<span class="token comment"># &quot;/images/1.gif&quot;请求匹配configuration D: </span>
<span class="token comment"># &quot;/documents/1.jpg&quot;请求匹配configuration E。</span>

<span class="token comment"># 注意:正则匹配会根据匹配顺序，找到第一个匹配的正则表达式后将停止搜索。</span>
<span class="token comment"># 普通字符串匹配则无视顺序，只会选择最精确的匹配。</span>
</code></pre></div><ul><li>tcp_nodelay （delay  [dɪˈleɪ]  延迟）</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> tcp_nodelay <span class="token boolean">on</span> | <span class="token boolean">off</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> tcp_nodelay <span class="token boolean">on</span></span><span class="token punctuation">;</span>
context: http, server, location
</code></pre></div><p>当连接转换为保持活动(keep-alive)状态时，启用该选项。此外，它在SSL连接、无缓冲代理和WebSocket代理上也要启用。（这个选项仅在将连接转变为长连接的时候才被启用。）（需要频繁的发送一些小包数据并且不希望放置缓冲区而是直接发送时开启）</p> <ul><li>tcp_nopush（push [pʊʃ]）</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> tcp_nopush <span class="token boolean">on</span> | <span class="token boolean">off</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> tcp_nopush <span class="token boolean">off</span></span><span class="token punctuation">;</span>
context: http, server, location
</code></pre></div><p>启用或禁FreeBSD上的tcp_nopush socket选项或Linux上的tcp_cork socket选项。只有在使用sendfile时才启用这些选项。（其功能和tcp_nodelay功能正好相反）</p> <ul><li>senfile</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> sendfile <span class="token boolean">on</span> | <span class="token boolean">off</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> sendfile <span class="token boolean">off</span></span><span class="token punctuation">;</span>
Context: http, server, location, if in location
</code></pre></div><p>启用或禁用sendfile()的使用。从nginx 0.8.12和FreeBSD 5.2.1开始，AIO（即Async非阻塞，是异步非阻塞的IO）可用于预加载sendfile()的数据。</p> <p>不开启sendfile():
硬盘 &gt;&gt; kernel buffer &gt;&gt; user buffer &gt;&gt; kernel socket buffer &gt;&gt;协议栈</p> <p>开启sendfile():
硬盘 &gt;&gt; kernel buffer (快速拷贝到ker nelsocket buffer) &gt;&gt;协议栈</p> <p>当 Nginx是一个静态文件服务器的时候，开启sendfile配置项能大大提高Nginx的性能。</p> <p>例如:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /video/</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">sendfile</span>	<span class="token boolean">on</span></span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">tcp_</span> nopush	<span class="token boolean">on</span></span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">aio</span>		    <span class="token boolean">on</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>server_tokens</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> server_tokens <span class="token boolean">on</span> | <span class="token boolean">off</span> | build | string</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> server_tokens <span class="token boolean">on</span></span><span class="token punctuation">;</span>
context: http, server, location
</code></pre></div><p>在错误页和”服务器”响应头字段中启用或禁用发出nginx版本。</p> <ul><li>error_page</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> error_page code ... [=[response]] uri</span><span class="token punctuation">;</span>
Default: -
Context: http, server, location, if in location
</code></pre></div><p>定义为指定错误显示的URI。URI值可以包含变量。</p> <p>例如:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">error_page</span> <span class="token number">404</span>		/404.html</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">error_page</span> <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> /50x.html</span><span class="token punctuation">;</span>

<span class="token comment"># 这将导致内部重定向到指定的URI,客户端请求方法更改为&quot;GET&quot; (对于除&quot;GET&quot;和&quot;HEAD&quot;之外的所有方法)。</span>
<span class="token comment"># 此外，可以使用&quot;=response&quot;语法将响应代码更改为其他代码，例如:</span>
<span class="token directive"><span class="token keyword">ror_page</span> <span class="token number">404</span> =200 /empty.gif</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>keepalive_timeout</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> keepalive_timeout timeout [header_timeout]</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> keepalive_timeout <span class="token number">75s</span></span><span class="token punctuation">;</span>
Context: http, server, location
</code></pre></div><p>设定客户端保持连接超时时长，0表示禁止。 Mozilla和Konqueror可以识别， MSIE自己会在60s后关闭连接。</p> <p>Konqueror （孔克洛）是 KDE 桌面系统的一部分，主要用于 Linux 和 BSD家族的操作系统。在微软的 Windows 系统下，也有零星使用，当然功能相对有限。Konqueror主要用于文件管理、浏览，以及网页浏览。Konqueror 按照 GPL 进行发布。</p> <ul><li>keepalive_requests</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> keepalive_requests number</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> keepalive_requests <span class="token number">100</span></span><span class="token punctuation">;</span>
Context: http, server, location
</code></pre></div><p>设置通过一个保持活动连接可以提供服务的最大请求数。在发出最大请求数后，连接将关闭。</p> <ul><li>keepalive_disable</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> keepalive_disable none | browser ...</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> keepalive_disab1e msie6</span><span class="token punctuation">;</span>
Context: http, server, location
</code></pre></div><p>禁止与那些行为不正常的浏览器保持活动连接。</p> <ul><li>send_timeout</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> send_timeout time</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> send_timeout <span class="token number">60s</span></span><span class="token punctuation">;</span>
Context: http, server, location
</code></pre></div><p>设置向客户端发送响应的超时时间。超时仅在两个连续的写入操作之间设置，不用于传输整个响应。如果客户端在此时间内未收到任何内容，则连接将关闭。</p> <ul><li>client_body_buffer_size</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> client_body_buffer_size size</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> client_body_buffer_size <span class="token number">8k</span> |16k</span><span class="token punctuation">;</span>
Context: http, server, location
</code></pre></div><p>设置读取客户端请求body部分的buffer大小。如果请求body大于缓冲区，则整个body或其部分将写入临时文件。默认情况下，缓冲区大小等于两个内存页。x86平台默认是8k，x86_ 64平台是16k。</p> <ul><li>client_body_temp_path</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> client_body_temp_path path [1evel1 [1evel2 [leve13]]]</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> client_body_temp_path client_body_temp</span><span class="token punctuation">;</span>
Context: http, server, location
</code></pre></div><p>定义用于存储保存客户端请求body的临时文件的目录。指定目录下最多可以使用三级子目录层次结构。例如:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 这里的level1,2,3如果有值就代表存在一级，二级，三级子目录。</span>
<span class="token comment"># 目录名是由数字进行命名的，所以这里的具体的值就是代表目录名的数字位数</span>
<span class="token directive"><span class="token keyword">client_body_temp_path</span> /spoo1/nginx/client_temp <span class="token number">1</span> <span class="token number">2</span></span><span class="token punctuation">;</span>
<span class="token comment"># 临时文件的路径可能看起来像下面所示:</span>
/spoo1/nginx/client_temp/7/45/00000123457
</code></pre></div><ul><li>client_max_body_size</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> client_max_body_size size</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> client_max_body_size <span class="token number">1m</span></span><span class="token punctuation">;</span>
Context: http, server, location
</code></pre></div><p>设置客户端请求body部分的最大值。指定在请求头的&quot;Content-Length&quot;区域。 如果超出这个值，则返回413错误。将大小设置为0将禁用对客户端请求body大小的检查。</p> <ul><li>limit_rate ([reɪt])</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> limit_rate rate</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> limit_rate <span class="token number">0</span></span><span class="token punctuation">;</span>
context: http, server, location, if in location
</code></pre></div><p>限制响应给客户端的传输速率，单位是bytes/second,默认值0表示无限制。</p> <ul><li>limit_except ( [ɪkˈsept] )</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">syntax:</span> limit_except method ...</span> <span class="token punctuation">{</span> ... <span class="token punctuation">}</span>
Default: -
Context: location
</code></pre></div><p>限制在location内使用的http方法。方法包括: GET, HEAD, POST, PUT, DELETE, MKCOL, COPY, MOVE,OPTIONS, PROPFIND, PROPPATCH, LOCK, UNLOCK, PATCH。允许GET方法时, HEAD方法也会被允许。例如:</p> <p>（allow [əˈlaʊ]   deny  [dɪˈnaɪ] ）</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">limit_except</span> GET</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">allow</span> 192.168.1.0/24</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">#除了GET和HEAD之外其它方法仅允许192.168.1.0/24网段主机使用</span>
</code></pre></div><h2 id="_3-访问控制模块"><a href="#_3-访问控制模块" class="header-anchor">#</a> 3，访问控制模块</h2> <p>此模块允许限制对特定客户机地址的访问</p> <ul><li>allow</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> allow address | CIDR | unix: | all</span><span class="token punctuation">;</span>
Default: -
Context: http, server, location, limit_except
</code></pre></div><p>指定允许访问的地址或网格</p> <ul><li>deny</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> deny address | CIDR | unix: | a11</span><span class="token punctuation">;</span>
Default: -
Context: http, server, location, limit_except
</code></pre></div><p>指定拒绝的地址或网络</p> <p>例如:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">deny</span> 192.168.1.1</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">allow</span> 192.168.1.0/24</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">allow</span> 10.1.1.0/16</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">allow</span> 2001:0db8::/32</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment"># 规则按顺序检查，直到找到第一个匹配项。</span>
</code></pre></div><h2 id="_4、用户认证模块-ngx-http-auth-basic-module"><a href="#_4、用户认证模块-ngx-http-auth-basic-module" class="header-anchor">#</a> 4、用户认证模块(ngx_ http_ <em>auth</em> basic_ module)</h2> <p>此模块使用HTTP Basic Authentication协议限制对资源的访问，通过用户名和密码方式。</p> <ul><li>auth_basic</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">syntax:</span> auth_basic string | <span class="token boolean">off</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">Default:</span> auth_basic <span class="token boolean">off</span></span><span class="token punctuation">;</span>
Context: http, server, location, limit_except
</code></pre></div><p>激活和关闭认证功能。</p> <ul><li>auth_basic_user_file</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> auth_basic_user_file file</span><span class="token punctuation">;</span>
Default: -
Context: http, server, location, limit_except
</code></pre></div><p>指定保存用户名和密码的文件。格式如下:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># comment</span>
name1: password1
name2: password2:comment
name3: password3

<span class="token comment"># 也可以使用密文。可以通过使用apatch的htpasswd命令(http-tools提供)</span>
<span class="token comment"># 或者openssl passwd命令</span>
</code></pre></div><p>配置案例：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /admin/</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">auth_basic</span> <span class="token string">&quot;Admin Area&quot;</span></span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">auth_basic_user_file</span> /etc/nginx/.ngxpasswd</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">auth_basic</span>	<span class="token string">&quot;closed site&quot;</span></span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">auth_basic_user_file</span> conf/htpasswd</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5、基本状态查看模块-ngx-http-stub-status-module"><a href="#_5、基本状态查看模块-ngx-http-stub-status-module" class="header-anchor">#</a> 5、基本状态查看模块(ngx_http_stub_status_module)</h2> <p>提供对基本状态信息的访问</p> <ul><li>stub_status</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">Syntax:</span> stub_status</span><span class="token punctuation">;</span>
Default: -
Context: server, location
</code></pre></div><p>在1.7.5之前的版本:&quot;stub_status on&quot;。
配置案例:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> = /basic_status</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">stub_status</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">location</span> /status</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">stub_status</span></span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">allow</span> 172.16.0.0/16</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment"># 输出nginx的基本状态信息</span>
<span class="token comment"># Active connections:当前状态, 活动状态的连接数</span>
<span class="token comment"># accepts: 统计总值, 已经接受的客户端请求的总数</span>
<span class="token comment"># handled: 统计总值, 已经处理完成的客户端请求的总数</span>
<span class="token comment"># requests: 统计总值, 客户端发来的总的请求数</span>
<span class="token comment"># Reading: 当前状态, 正在读取客户端请求报文首部的连接的连接数</span>
<span class="token comment"># writing: 当前状态, 正在向客户端发送响应报文过程中的连接数</span>
<span class="token comment"># waiting: 当前状态, 正在等待客户端发出请求的空闲连接数</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/nginx/01_nginxan-zhuang-ji-pei-zhi/3.nginxpei-zhi-wen-jian.html" class="prev">
        Nginx配置文件结构
      </a></span> <span class="next"><a href="/docs/nginx/02_nginxmo-kuai-guan-li/nginxchang-yong-mo-kuai-02.html">
        Nginx常用模块二
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.27b283a1.js" defer></script><script src="/docs/assets/js/2.2e8f894a.js" defer></script><script src="/docs/assets/js/11.84b24849.js" defer></script>
  </body>
</html>
